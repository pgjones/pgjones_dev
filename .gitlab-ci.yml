stages:
  - lint-test
  - push

frontend-ci:
  stage: lint-test

  image: node:10-alpine

  cache:
    key: pgjones-node-cache
    paths:
      - frontend/node_modules/

  before_script:
  - apk --update add yarn
  - cd frontend && yarn install

  script:
  - yarn run format

  only:
    changes:
      - frontend/**/*
      - .gitlab-ci.yml

backend-ci:
  stage: lint-test

  image: python:3.8-alpine

  cache:
    key: pgjones-poetry-cache
    paths:
      - backend/.venv

  before_script:
  - apk --update add alpine-sdk libffi-dev libxml2-dev libxslt-dev openssl openssl-dev bsd-compat-headers
  - pip install poetry
  - poetry config virtualenvs.in-project true
  - cd backend && poetry install

  script:
  - poetry run format
  - poetry run lint

  only:
    changes:
      - backend/**/*
      - .gitlab-ci.yml

docker-ci:
  stage: lint-test

  image: hadolint/hadolint:latest-debian

  script:
    - hadolint Dockerfile

  only:
    changes:
      - Dockerfile
      - .gitlab-ci.yml

ecr-push:
  stage: push

  image: docker:latest

  services:
    - docker:19.03.5-dind

  before_script:
    - apk add --no-cache curl jq python3 py-pip
    - pip install docutils==0.14 awscli

  script:
    - $(aws ecr get-login --no-include-email --region eu-west-1)
    - docker pull $AWS_REPOSITORY_URL || true
    - docker build --build-arg CI_COMMIT_SHA=$CI_COMMIT_SHA --cache-from $AWS_REPOSITORY_URL -t $AWS_REPOSITORY_URL .
    - docker push $AWS_REPOSITORY_URL
  only:
    - master
  tags:
    - docker
