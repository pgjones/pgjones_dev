stages:
  - lint-test
  - push

frontend-ci:
  stage: lint-test

  image: node:10-alpine

  before_script:
  - apk --update add yarn
  - cd frontend && yarn install

  script:
  - yarn run format
  - yarn run lint
  - yarn run test
  - yarn run build

backend-ci:
  stage: lint-test

  image: python:3.7-alpine

  before_script:
  - apk --update add alpine-sdk libffi-dev
  - pip install poetry
  - cd backend && poetry install

  script:
  - poetry run format
  - poetry run lint
  - poetry run test

docker-ci:
  stage: lint-test

  image: hadolint/hadolint:latest-debian

  script:
    - hadolint Dockerfile

ecr-push:
  stage: push

  image: docker:latest

  services:
    - docker:dind

  before_script:
    - apk add --no-cache curl jq python py-pip
    - pip install awscli

  script:
    - $(aws ecr get-login --no-include-email --region eu-west-2)
    - docker build --build-arg CI_COMMIT_SHA=$CI_COMMIT_SHA -t $AWS_REPOSITORY_URL .
    - docker push $AWS_REPOSITORY_URL
  only:
    - master
  tags:
    - docker
